<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω ƒê∆°n h√†ng Pizza</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }

    .login-box h1 {
      margin-bottom: 30px;
      color: #e74c3c;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }

    input, select, button {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.3s;
  background: white;
}

input:focus, select:focus {
  outline: none;
  border-color: #e74c3c;
  box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
}

select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23e74c3c' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 40px;
}

select:hover {
  border-color: #e74c3c;
}

@media (max-width: 768px) {
  input, select {
    padding: 16px;
    font-size: 16px;
    min-height: 48px;
  }
  
  select {
    background-position: right 16px center;
  }
}
    /* TH√äM M·ªöI - ƒë·ªÉ dropdown v√† input to h∆°n tr√™n mobile */
@media (max-width: 768px) {
  input, select {
    padding: 16px;
    font-size: 16px;
    min-height: 48px;
  }
}

    button {
      background: #e74c3c;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }

    button:hover {
      background: #c0392b;
    }

    .main-app {
      display: none;
    }

    .header {
      background: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .store-badge {
      background: #e74c3c;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
    }

    .logout-btn {
      background: #95a5a6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .logout-btn:hover {
      background: #7f8c8d;
    }

    .tabs {
      background: white;
      display: flex;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #777;
      transition: all 0.3s;
    }

    .tab.active {
      color: #e74c3c;
      border-bottom: 3px solid #e74c3c;
    }

    .tab-content {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .tab-content.active {
      display: block;
    }

    .order-form {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .menu-items {
      margin-top: 20px;
    }

    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .menu-item:hover {
      background: #f9f9f9;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .qty-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e74c3c;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qty-btn:hover {
      background: #c0392b;
    }

    .order-summary {
      margin-top: 20px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .total-row {
      font-size: 18px;
      font-weight: 700;
      color: #e74c3c;
      padding-top: 10px;
      border-top: 2px solid #ddd;
    }

    .orders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .order-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e8e8e8;
      transition: box-shadow 0.3s;
    }

    .order-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e8e8e8;
    }

    .order-type {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      background: #f5f5f5;
      color: #333;
    }


    .table-select {
      margin-top: 10px;
    }

    .category-section {
      margin-bottom: 20px;
    }

    .category-header {
      background: #e74c3c;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s;
    }

    .category-header:hover {
      background: #c0392b;
    }

    .category-header.active {
      border-radius: 8px 8px 0 0;
    }

    .category-items {
      display: none;
      background: white;
      border: 2px solid #e74c3c;
      border-top: none;
      border-radius: 0 0 8px 8px;
      padding: 10px;
    }

    .category-items.show {
      display: block;
    }

    .category-icon {
      font-size: 20px;
      transition: transform 0.3s;
    }

    .category-icon.rotate {
      transform: rotate(180deg);
    }

    .order-items {
      margin: 15px 0;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .payment-buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.payment-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  background: #27ae60;  /* M·ªôt m√†u xanh l√° th·ªëng nh·∫•t */
  color: white;
}

.payment-btn:hover {
  background: #229954;
}
    
    .report-section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .report-section h2 {
      margin-bottom: 20px;
      color: #e74c3c;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #e74c3c;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #777;
      font-size: 14px;
    }

    .cash-register {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
    }

    .cash-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .cash-input-group input {
      flex: 1;
    }

    .cash-info {
      display: flex;
      justify-content: space-between;
      padding: 15px;
      background: white;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .submit-btn {
      background: #27ae60;
      margin-top: 20px;
    }

    .submit-btn:hover {
      background: #229954;
    }

    .reset-btn {
      background: #e74c3c;
      margin-top: 10px;
    }

    .reset-btn:hover {
      background: #c0392b;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .orders-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

     .modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: white;
  margin: 5% auto;
  padding: 0;
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
  background: #e74c3c;
  color: white;
  padding: 20px;
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-body {
  padding: 30px;
}

.close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 28px;
  cursor: pointer;
  width: auto;
  padding: 0;
}

.bill-item {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid #eee;
}

.bill-total {
  display: flex;
  justify-content: space-between;
  padding: 20px 0 10px 0;
  border-top: 2px solid #e74c3c;
  font-size: 20px;
  font-weight: 700;
  color: #e74c3c;
  margin-top: 15px;
}
/* Th√™m v√†o cu·ªëi ph·∫ßn CSS hi·ªán t·∫°i */

.edit-order-btn {
  background: #f39c12;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  margin-right: 8px;
}

.edit-order-btn:hover {
  background: #e67e22;
}

.delete-item-btn {
  background: #e74c3c;
  color: white;
  border: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
  margin-left: 10px;
}

.delete-item-btn:hover {
  background: #c0392b;
}

.order-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 14px;
}

.order-item-left {
  display: flex;
  align-items: center;
  flex: 1;
}

.edit-mode .order-item {
  background: #fff3cd;
  padding: 8px;
  border-radius: 6px;
  margin-bottom: 10px;
}

.item-qty-control {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: 10px;
}

.item-qty-btn {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #e74c3c;
  color: white;
  border: none;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.item-qty-btn:hover {
  background: #c0392b;
}

.qr-badge {
  background: #27ae60;
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  margin-left: 8px;
}

* {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
    }

    /* LOGIN SCREEN */
    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 420px;
    }

    .login-box h1 {
      margin-bottom: 10px;
      color: #e74c3c;
      text-align: center;
      font-size: 28px;
    }

    .security-badge {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      text-align: center;
      margin-bottom: 25px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    }

    input {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #e74c3c;
      box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
    }

    .password-wrapper {
      position: relative;
    }

    .toggle-password {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      padding: 0;
      width: auto;
    }

    button {
      width: 100%;
      padding: 14px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s;
    }

    button:hover {
      background: #c0392b;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: #fee;
      color: #c00;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      font-size: 14px;
      border-left: 4px solid #c00;
      animation: shake 0.3s;
    }

    .error-message.show {
      display: block;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .loading-spinner {
      display: none;
      text-align: center;
      margin-top: 15px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #e74c3c;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* MAIN APP */
    .main-app {
      display: none;
      background: #f5f5f5;
      min-height: 100vh;
    }

    .header {
      background: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-info {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .role-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .role-admin {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .role-manager {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }

    .role-staff {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white;
    }

    .role-kitchen {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
    }

    .store-badge {
      background: #95a5a6;
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .logout-btn {
      background: #95a5a6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .logout-btn:hover {
      background: #7f8c8d;
    }

    .tabs {
      background: white;
      display: flex;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #777;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: #e74c3c;
      border-bottom: 3px solid #e74c3c;
    }

    .tab.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .tab-content {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .tab-content.active {
      display: block;
    }

    .access-denied {
      background: white;
      padding: 60px 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .access-denied-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .help-text {
      margin-top: 15px;
      font-size: 13px;
      color: #999;
      text-align: center;
    }

    /* LOGIN SCREEN */
    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 420px;
    }

    .login-box h1 {
      margin-bottom: 10px;
      color: #e74c3c;
      text-align: center;
      font-size: 28px;
    }

    .security-badge {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      text-align: center;
      margin-bottom: 25px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    }

    input {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #e74c3c;
      box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
    }

    .password-wrapper {
      position: relative;
    }

    .toggle-password {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      padding: 0;
      width: auto;
    }

    button {
      width: 100%;
      padding: 14px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s;
    }

    button:hover {
      background: #c0392b;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: #fee;
      color: #c00;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      font-size: 14px;
      border-left: 4px solid #c00;
      animation: shake 0.3s;
    }

    .error-message.show {
      display: block;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .loading-spinner {
      display: none;
      text-align: center;
      margin-top: 15px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #e74c3c;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* MAIN APP */
    .main-app {
      display: none;
      background: #f5f5f5;
      min-height: 100vh;
    }

    .header {
      background: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-info {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .role-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .role-admin {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .role-manager {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }

    .role-staff {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white;
    }

    .role-kitchen {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
    }

    .store-badge {
      background: #95a5a6;
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .logout-btn {
      background: #95a5a6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .logout-btn:hover {
      background: #7f8c8d;
    }

    .tabs {
      background: white;
      display: flex;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #777;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: #e74c3c;
      border-bottom: 3px solid #e74c3c;
    }

    .tab.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .tab-content {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .tab-content.active {
      display: block;
    }

    .access-denied {
      background: white;
      padding: 60px 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .access-denied-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .help-text {
      margin-top: 15px;
      font-size: 13px;
      color: #999;
      text-align: center;
    }
    
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>üîí Pizza Manager</h1>
      <div class="security-badge">üõ°Ô∏è H·ªá th·ªëng b·∫£o m·∫≠t RBAC</div>
      
      <div class="error-message" id="errorMessage"></div>
      
      <form onsubmit="login(event)">
        <div class="form-group">
          <label>üë§ T√™n ƒëƒÉng nh·∫≠p</label>
          <input 
            type="text" 
            id="username" 
            placeholder="Nh·∫≠p username"
            autocomplete="username"
            required
          >
        </div>
        
        <div class="form-group">
          <label>üîë M·∫≠t kh·∫©u</label>
          <div class="password-wrapper">
            <input 
              type="password" 
              id="password" 
              placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
              autocomplete="current-password"
              required
            >
            <button type="button" class="toggle-password" onclick="togglePassword()">üëÅÔ∏è</button>
          </div>
        </div>
        
        <button type="submit" id="loginBtn">üîê ƒêƒÉng nh·∫≠p</button>
      </form>
      
      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <p style="margin-top: 10px; color: #777;">ƒêang x√°c th·ª±c...</p>
      </div>

      <div class="help-text">
        üí° Li√™n h·ªá qu·∫£n l√Ω n·∫øu qu√™n m·∫≠t kh·∫©u
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="main-app" id="mainApp">
    <div class="header">
      <div class="header-info">
        <h2>üçï Pizza Manager</h2>
        <span class="role-badge" id="roleBadge"></span>
        <span class="store-badge" id="storeBadge"></span>
        <span id="userDisplay"></span>
      </div>
      <button class="logout-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
    </div>

    <div class="tabs">
      <div class="tab" id="tab-order" onclick="switchTab('order')">üìù Nh·∫≠p ƒê∆°n</div>
      <div class="tab" id="tab-current" onclick="switchTab('current')">üìã ƒê∆°n Hi·ªán T·∫°i</div>
      <div class="tab" id="tab-report" onclick="switchTab('report')">üìä B√°o C√°o</div>
    </div>

    <!-- Tab: Nh·∫≠p ƒê∆°n -->
    <div class="tab-content" id="content-order">
      <div class="access-denied" id="orderAccessDenied" style="display: none;">
        <div class="access-denied-icon">üö´</div>
        <h2>Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p</h2>
        <p style="color: #777; margin-top: 10px;">B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o ƒë∆°n h√†ng m·ªõi</p>
      </div>
      <div id="orderFormContainer">
        <h2>üìù T·∫°o ƒê∆°n H√†ng M·ªõi</h2>
        <p style="color: #777; margin-top: 10px;">Form nh·∫≠p ƒë∆°n ·ªü ƒë√¢y...</p>
      </div>
    </div>

    <!-- Tab: ƒê∆°n Hi·ªán T·∫°i -->
    <div class="tab-content" id="content-current">
      <!-- ‚≠ê TH√äM ACCESS DENIED -->
  <div class="access-denied" id="currentAccessDenied" style="display: none;">
    <div class="access-denied-icon">üö´</div>
    <h2>Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p</h2>
    <p style="color: #777; margin-top: 10px;">B·∫°n kh√¥ng c√≥ quy·ªÅn xem ƒë∆°n h√†ng hi·ªán t·∫°i</p>
    <p style="color: #999; margin-top: 5px; font-size: 13px;">Ch·ªâ qu·∫£n l√Ω m·ªõi c√≥ th·ªÉ xem v√† x·ª≠ l√Ω ƒë∆°n</p>
  </div>
  <div id="currentOrdersContainer"></div>
      <h2>üìã ƒê∆°n H√†ng Hi·ªán T·∫°i</h2>
      <div id="ordersGrid">
        <p style="text-align: center; color: #999; margin-top: 40px;">ƒêang t·∫£i ƒë∆°n h√†ng...</p>
      </div>
    </div>

    <!-- Tab: B√°o C√°o -->
<div class="tab-content" id="content-report">
  <!-- ‚≠ê TH√äM PH·∫¶N ACCESS DENIED -->
  <div class="access-denied" id="reportAccessDenied" style="display: none;">
    <div class="access-denied-icon">üö´</div>
    <h2>Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p</h2>
    <p style="color: #777; margin-top: 10px;">B·∫°n kh√¥ng c√≥ quy·ªÅn xem b√°o c√°o</p>
  </div>
  <h2>üìà B√°o C√°o H√¥m Nay</h2>
<div id="reportContainer">
  <div class="report-section">
    <div class="category-header" onclick="toggleReportSection('revenue')">
      <span>üìä Doanh Thu</span>
      <span class="category-icon" id="icon-revenue">‚ñº</span>
    </div>
    <div class="category-items" id="items-revenue">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalRevenue">0ƒë</div>
          <div class="stat-label">T·ªïng doanh thu</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="cashRevenue">0ƒë</div>
          <div class="stat-label">Ti·ªÅn m·∫∑t</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="transferRevenue">0ƒë</div>
          <div class="stat-label">Chuy·ªÉn kho·∫£n</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="grabRevenue">0ƒë</div>
          <div class="stat-label">Grab</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="shopeeRevenue">0ƒë</div>
          <div class="stat-label">Shopee</div>
        </div>
      </div>
    </div>
  </div>

  <div class="report-section">
    <div class="category-header" onclick="toggleReportSection('items')">
      <span>üçï M√≥n ƒê√£ B√°n</span>
      <span class="category-icon" id="icon-items">‚ñº</span>
    </div>
    <div class="category-items" id="items-items">
      <div id="soldItems"></div>
    </div>
  </div>

  <div class="report-section">
    <div class="category-header" onclick="toggleReportSection('cash')">
      <span>üí∞ Qu·∫£n L√Ω K√©t Ti·ªÅn</span>
      <span class="category-icon" id="icon-cash">‚ñº</span>
    </div>
    <div class="category-items" id="items-cash">
      <div class="cash-register">
        <div class="cash-input-group">
          <input type="number" id="startCash" placeholder="Nh·∫≠p ti·ªÅn ƒë·∫ßu ng√†y">
          <button onclick="setStartCash()">C·∫≠p nh·∫≠t</button>
        </div>
        <div class="cash-info">
          <span>Ti·ªÅn ƒë·∫ßu ng√†y:</span>
          <strong id="displayStartCash">0ƒë</strong>
        </div>
        <div class="cash-info">
          <span>Ti·ªÅn m·∫∑t thu ƒë∆∞·ª£c:</span>
          <strong id="displayCashRevenue">0ƒë</strong>
        </div>
        <div class="cash-info">
          <span>T·ªïng k√©t ti·ªÅn:</span>
          <strong id="displayTotalCash">0ƒë</strong>
        </div>
        <button class="reset-btn" onclick="resetCashRegister()">Ch·ªët K√©t & Reset</button>
      </div>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
  

  <script>
    const menuData = {
            'Pizza': [
            { id: 'p1', name: 'B√≤ (Size S)', price: 39000 },
            { id: 'p2', name: 'Ph√¥ mai (Size S)', price: 39000 },
            { id: 'p3', name: 'G√† teriyaki (Size S)', price: 39000 },
            { id: 'p4', name: 'X√∫c x√≠ch heo (Size S)', price: 39000 },
            { id: 'p5', name: 'C√° ng·ª´ (Size S)', price: 39000 },
            { id: 'p6', name: 'Ba r·ªçi x√¥ng kh√≥i (Size S)', price: 39000 },

            { id: 'p7', name: 'B√≤ (Size L)', price: 89000 },
            { id: 'p8', name: 'Ph√¥ mai (Size L)', price: 89000 },
            { id: 'p9', name: 'G√† teriyaki (Size L)', price: 89000 },
            { id: 'p10', name: 'H·∫£i s·∫£n (Size L)', price: 89000 },
            { id: 'p11', name: 'X√∫c x√≠ch heo (Size L)', price: 89000 },
            { id: 'p12', name: 'Pizza n·∫•m rau c·ªß (Size L)', price: 89000 },
            { id: 'p13', name: 'X√∫c x√≠ch ƒê·ª©c (Size L)', price: 89000 },
            { id: 'p14', name: 'C√° ng·ª´ (Size L)', price: 89000 },
            { id: 'p15', name: 'Ba r·ªçi x√¥ng kh√≥i (Size L)', price: 89000 },
            { id: 'p16', name: 'Salami (Size L)', price: 109000 },
            { id: 'p17', name: 'Ph√¥ mai t∆∞∆°i (Size L)', price: 99000 },
            { id: 'p18', name: "Meat Lover's (Size L)", price: 109000 },
            { id: 'p19', name: 'T√¥m thanh cua (Size L)', price: 99000 },
            { id: 'p20', name: 'Kh√¥ G√† - L·∫°p X∆∞·ªüng (Size L)', price: 99000 },
            { id: 'p21', name: 'Th·∫≠p C·∫©m (Size L)', price: 109000 },
            { id: 'p22', name: 'B√≤ s·ªët cay (Size L)', price: 109000 },
            { id: 'p23', name: 'H·∫£i s·∫£n ƒë·∫∑c bi·ªát (Size L)', price: 99000 }
        ],

        'M√≥n ƒÇn Nh·∫π': [
            { id: 's1', name: 'G√† S·ªët Cay', price: 29000 },
            { id: 's2', name: 'Khoai t√¢y chi√™n (nh·ªè)', price: 15000 },
            { id: 's3', name: 'Khoai t√¢y chi√™n (l·ªõn)', price: 25000 },
            { id: 's4', name: 'Tok L·∫Øc Ph√¥ Mai', price: 15000 },
            { id: 's5', name: 'B√°nh M√¨ B∆° T·ªèi', price: 15000 },
            { id: 's6', name: 'G√† l·∫Øc ph√¥ mai cay (nh·ªè)', price: 25000 },
            { id: 's7', name: 'G√† l·∫Øc ph√¥ mai cay (l·ªõn)', price: 35000 },
            { id: 's8', name: 'G√† r√°n chi√™n gi√≤n (nh·ªè)', price: 25000 },
            { id: 's9', name: 'G√† r√°n chi√™n gi√≤n (l·ªõn)', price: 30000 },
            { id: 's10', name: 'M√¨ √ù ƒë√∫t l√≤', price: 59000 },
            { id: 's11', name: 'M√¨ √ù s·ªët b√≤ b·∫±m', price: 39000 },
            { id: 's12', name: 'Salad C√° Ng·ª´', price: 39000 },
            { id: 's13', name: 'Salad d·∫ßu gi·∫•m', price: 29000 },
            { id: 's14', name: 'B√°nh m√¨ ph√¥ mai', price: 25000 },
            { id: 's15', name: 'B·∫Øp Ph√¥ Mai', price: 29000 }
        ],

        'N∆∞·ªõc': [
            { id: 'd1', name: 'N∆∞·ªõc ng·ªçt (ly)', price: 9000 },
            { id: 'd2', name: 'N∆∞·ªõc ng·ªçt (lon)', price: 15000 },
            { id: 'd3', name: 'N∆∞·ªõc su·ªëi', price: 9000 },
            { id: 'd4', name: 'Local Beer', price: 15000 },
            { id: 'd5', name: 'ƒê√° me h·∫°t m·ªÅm', price: 15000 },
            { id: 'd6', name: 'Tr√† Chanh', price: 15000 },
            { id: 'd7', name: 'Tr√† ƒê√†o', price: 20000 },
            { id: 'd8', name: 'Tr√† s·ªØa Th√°i', price: 20000 }
        ],

      'Combo': [
            { id: 'c1', name: 'Combo 1 (1 Pizza b·∫•t k·ª≥ + 1 g√† l·∫Øc ph√¥ mai cay + 2 n∆∞·ªõc ng·ªçt)', price: 119000 },

            { id: 'c2', name: 'Combo 2 (1 Pizza b·∫•t k·ª≥ + 3 g√† r√°n + 3 n∆∞·ªõc ng·ªçt)', price: 179000 },

            { id: 'c3', name: 'Combo 3 (2 Pizza b·∫•t k·ª≥ + 1 g√† l·∫Øc ph√¥ mai cay + 1 khoai t√¢y chi√™n + 4 n∆∞·ªõc ng·ªçt)', price: 229000 },

            { id: 'c4', name: 'Combo 4 (1 Pizza b·∫•t k·ª≥ + 1 salad c√° ng·ª´ + 2 n∆∞·ªõc ng·ªçt)', price: 139000 },

            { id: 'c5', name: 'Combo 5 (1 Pizza b·∫•t k·ª≥ + 1 salad c√° ng·ª´ + 2 m√¨ √ù + 4 n∆∞·ªõc ng·ªçt)', price: 229000 },

            { id: 'c6', name: 'Combo 6 (1 Pizza b·∫•t k·ª≥ + 1 salad c√° ng·ª´ + 1 m√¨ √ù + 2 n∆∞·ªõc ng·ªçt)', price: 159000 },

            { id: 'c7', name: 'Combo 7 (1 Pizza size S b·∫•t k·ª≥ + 1 n∆∞·ªõc ng·ªçt)', price: 45000 },

            { id: 'c8', name: 'Combo 8 (1 Pizza size S b·∫•t k·ª≥ + 1 khoai t√¢y chi√™n + 1 n∆∞·ªõc ng·ªçt)', price: 59000 }
            ],

            'Add - on': [
            { id: 'a1', name: 'Ph√¥ mai th√™m S', price: 10000 },
            { id: 'a2', name: 'Ph√¥ mai th√™m L', price: 20000 },
            { id: 'a3', name: 'B√≤ th√™m', price: 10000 },
    ]
    };

    // Th√™m v√†o ƒë·∫ßu ph·∫ßn <script>, sau khai b√°o menuData
    const SUPABASE_URL = 'https://mhmvtywqtaqikaubhhmf.supabase.co'; // Thay b·∫±ng URL c·ªßa b·∫°n
    const SUPABASE_ANON_KEY = 'sb_publishable_lTDNdWmRZaO2VF-oCs2zvg_7NSzJpCa'; // Thay b·∫±ng anon key c·ªßa b·∫°n
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


    let currentStore = '';
    let orders = [];
    let mergedOrders = [];
    let cart = {};
    let dailyReport = {
  revenue: { 
    total: 0, 
    cash: 0,
    transfer: 0,
    grab: 0,
    shopee: 0
  },
  items: {},
  cash: { start: 0, current: 0 }
};
let currentUser = null;
    let permissions = {
      canCreateOrder: false,
      canEditOrder: false,
      canViewOrders: false,
      canPayOrder: false,
      canViewReports: false,
      canManageCash: false
    };

  let searchTimeout = null;

    // üé≠ ƒê·ªäNH NGHƒ®A QUY·ªÄN THEO VAI TR√í
    const ROLE_PERMISSIONS = {
      admin: {
        canCreateOrder: true,
        canEditOrder: true,
        canViewOrders: true,
        canPayOrder: true,
        canViewReports: true,
        canManageCash: true
      },
      manager: {
        canCreateOrder: true,
        canEditOrder: true,
        canViewOrders: true,
        canPayOrder: true,
        canViewReports: true,
        canManageCash: true
      },
      staff: {
        canCreateOrder: true,
        canEditOrder: false,
        canViewOrders: false,     // ‚úÖ ƒê√öNG - KH√îNG cho xem
        canPayOrder: false,
        canViewReports: false,
        canManageCash: false
      },
      kitchen: {
        canCreateOrder: false,
        canEditOrder: false,
        canViewOrders: true,
        canPayOrder: false,
        canViewReports: false,
        canManageCash: false
      }
    };

// üîÑ TOGGLE PASSWORD
    function togglePassword() {
      const input = document.getElementById('password');
      const btn = event.target;
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'üôà';
      } else {
        input.type = 'password';
        btn.textContent = 'üëÅÔ∏è';
      }
    }
// ‚ùå HI·ªÇN TH·ªä L·ªñI
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = '‚ùå ' + message;
      errorDiv.classList.add('show');
      setTimeout(() => errorDiv.classList.remove('show'), 5000);
    }

   async function login(event) {
  event.preventDefault();

  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;

  if (!username || !password) {
    showError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
    return;
  }

  const loginBtn = document.getElementById('loginBtn');
  const spinner = document.getElementById('loadingSpinner');

  loginBtn.disabled = true;
  spinner.style.display = 'block';

  try {
    // ‚≠ê G·ªåI FUNCTION VERIFY
    const { data, error } = await supabase.rpc('verify_staff_login', {
      p_username: username,
      p_password: password
    });

    console.log('üîç Login response:', { data, error }); // Debug log

    if (error) {
      console.error('‚ùå Supabase error:', error);
      throw error;
    }

    // ‚ö†Ô∏è QUAN TR·ªåNG: data l√† array, ki·ªÉm tra c√≥ ph·∫ßn t·ª≠ kh√¥ng
    if (!data || data.length === 0) {
      showError('Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!');
      loginBtn.disabled = false;
      spinner.style.display = 'none';
      return;
    }

    // ‚úÖ L·∫§Y USER ƒê·∫¶U TI√äN
    const user = data[0];
    
    // ‚≠ê MAPPING ƒë√∫ng t√™n c·ªôt
    currentUser = {
      id: user.user_id,           // ‚Üê S·ª≠a t·ª´ id -> user_id
      username: user.username,
      full_name: user.full_name,
      store_code: user.store_code,
      role: user.role
    };

    permissions = ROLE_PERMISSIONS[currentUser.role];

    // L∆∞u session
    sessionStorage.setItem('pizza_user', JSON.stringify(currentUser));

    console.log('‚úÖ Login success:', currentUser);

    // Chuy·ªÉn sang m√†n h√¨nh ch√≠nh
    // Chuy·ªÉn sang m√†n h√¨nh ch√≠nh
await initMainApp();

  } catch (error) {
    console.error('üî• Login error:', error);
    showError('L·ªói h·ªá th·ªëng. Vui l√≤ng th·ª≠ l·∫°i!');
  } finally {
    loginBtn.disabled = false;
    spinner.style.display = 'none';
  }
}

// üé® KH·ªûI T·∫†O GIAO DI·ªÜN CH√çNH
async function initMainApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';

  // Hi·ªÉn th·ªã th√¥ng tin user
  const roleLabels = {
    admin: 'üëë Admin',
    manager: 'üëî Qu·∫£n L√Ω',
    staff: 'üë®‚Äçüíº Thu Ng√¢n',
    kitchen: 'üë®‚Äçüç≥ B·∫øp'
  };

  const storeNames = {
    'DH': 'Di√™n H·ªìng',
    'NH': 'Nguy·ªÖn Hu·ªá',
    'HXH': 'H·ªì Xu√¢n H∆∞∆°ng',
    'PY': 'Ph√∫ Y√™n',
    'ALL': 'T·∫•t c·∫£ chi nh√°nh'
  };

  document.getElementById('roleBadge').textContent = roleLabels[currentUser.role];
  document.getElementById('roleBadge').className = `role-badge role-${currentUser.role}`;
  document.getElementById('storeBadge').textContent = storeNames[currentUser.store_code];
  document.getElementById('userDisplay').textContent = currentUser.full_name;

  // L∆∞u store hi·ªán t·∫°i
  currentStore = currentUser.store_code;

  // ·∫®n/hi·ªán tab theo quy·ªÅn
  setupPermissions();

  // ‚≠ê LOAD D·ªÆ LI·ªÜU & RENDER
  await loadData();
  requestNotificationPermission();
  
  // ‚≠ê LU√îN RENDER FORM V√Ä MENU N·∫æU C√ì QUY·ªÄN
if (permissions.canCreateOrder) {
  renderOrderForm();
  renderMenu();
  updateOrderSummary();
}

// ‚≠ê LU√îN RENDER ORDERS N·∫æU C√ì QUY·ªÄN XEM
if (permissions.canViewOrders) {
  renderOrders();
}

// ‚≠ê C·∫¨P NH·∫¨T REPORTS N·∫æU C√ì QUY·ªÄN
if (permissions.canViewReports) {
  updateReports();
}

// Chuy·ªÉn ƒë·∫øn tab ƒë·∫ßu ti√™n ƒë∆∞·ª£c ph√©p
if (permissions.canCreateOrder) {
  switchTab('order');
} else if (permissions.canViewOrders) {
  switchTab('current');
} else if (permissions.canViewReports) {
  switchTab('report');
} else {
  // ‚≠ê KH√îNG C√ì QUY·ªÄN G√å C·∫¢
  alert('‚ö†Ô∏è T√†i kho·∫£n c·ªßa b·∫°n ch∆∞a ƒë∆∞·ª£c c·∫•p quy·ªÅn!\n\nVui l√≤ng li√™n h·ªá qu·∫£n l√Ω.');
  logout();
}
}

// üîê THI·∫æT L·∫¨P QUY·ªÄN TRUY C·∫¨P
function setupPermissions() {
  const orderTab = document.getElementById('tab-order');
  const currentTab = document.getElementById('tab-current');
  const reportTab = document.getElementById('tab-report');
  
  // ‚≠ê X√ìA T·∫§T C·∫¢ DISABLED TR∆Ø·ªöC (RESET)
  [orderTab, currentTab, reportTab].forEach(tab => {
    if (tab) {
      tab.classList.remove('disabled');
      tab.onclick = null; // X√≥a onclick c≈©
    }
  });
  
  // ‚≠ê G√ÅN L·∫†I ONCLICK CHO T·∫§T C·∫¢ TAB
  if (orderTab) {
    orderTab.onclick = () => switchTab('order');
  }
  if (currentTab) {
    currentTab.onclick = () => switchTab('current');
  }
  if (reportTab) {
    reportTab.onclick = () => switchTab('report');
  }
  
  // ‚≠ê CH·ªà DISABLE TAB KH√îNG C√ì QUY·ªÄN
  if (!permissions.canCreateOrder && orderTab) {
    orderTab.classList.add('disabled');
    orderTab.onclick = null;
  }
  
  if (!permissions.canViewOrders && currentTab) {
    currentTab.classList.add('disabled');
    currentTab.onclick = null;
  }
  
  if (!permissions.canViewReports && reportTab) {
    reportTab.classList.add('disabled');
    reportTab.onclick = null;
  }
  
  // ‚≠ê X·ª¨ L√ù ACCESS DENIED - TAB NH·∫¨P ƒê∆†N
  const orderAccessDenied = document.getElementById('orderAccessDenied');
  const orderFormContainer = document.getElementById('orderFormContainer');
  
  if (orderAccessDenied && orderFormContainer) {
    if (!permissions.canCreateOrder) {
      orderAccessDenied.style.display = 'block';
      orderFormContainer.style.display = 'none';
    } else {
      orderAccessDenied.style.display = 'none';
      orderFormContainer.style.display = 'block';
    }
  }
  
  // ‚≠ê X·ª¨ L√ù ACCESS DENIED - TAB ƒê∆†N HI·ªÜN T·∫†I
  const currentAccessDenied = document.getElementById('currentAccessDenied');
  const currentOrdersContainer = document.getElementById('currentOrdersContainer');
  
  if (currentAccessDenied && currentOrdersContainer) {
    if (!permissions.canViewOrders) {
      currentAccessDenied.style.display = 'block';
      currentOrdersContainer.style.display = 'none';
    } else {
      currentAccessDenied.style.display = 'none';
      currentOrdersContainer.style.display = 'block';
    }
  }
  
  // ‚≠ê X·ª¨ L√ù ACCESS DENIED - TAB B√ÅO C√ÅO
  const reportAccessDenied = document.getElementById('reportAccessDenied');
  const reportContainer = document.getElementById('reportContainer');
  
  if (reportAccessDenied && reportContainer) {
    if (!permissions.canViewReports) {
      reportAccessDenied.style.display = 'block';
      reportContainer.style.display = 'none';
    } else {
      reportAccessDenied.style.display = 'none';
      reportContainer.style.display = 'block';
    }
  }
}
// üìù RENDER FORM NH·∫¨P ƒê∆†N
function renderOrderForm() {
  const container = document.getElementById('orderFormContainer');
  
  container.innerHTML = `
    <div class="order-form">
      <h2>üìù T·∫°o ƒê∆°n H√†ng M·ªõi</h2>
      
      <div class="form-row">
        <div class="form-group">
          <label>Lo·∫°i ƒë∆°n h√†ng</label>
          <select id="orderType" onchange="toggleTableSelect()">
            <option value="dine">üçΩÔ∏è ƒÇn t·∫°i qu√°n</option>
            <option value="takeout">üì¶ Mang v·ªÅ</option>
            <option value="grab">üõµ Grab</option>
            <option value="shopee">üõí Shopee</option>
          </select>
        </div>
        
        <div class="form-group table-select" id="tableSelect">
          <label>S·ªë b√†n</label>
          <input type="number" id="tableNumber" placeholder="Nh·∫≠p s·ªë b√†n" min="1">
        </div>
      </div>

      <div class="form-group">
        <label>T√¨m ki·∫øm m√≥n</label>
        <input type="text" id="searchMenu" placeholder="Nh·∫≠p t√™n m√≥n..." oninput="searchMenu()">
      </div>

      <div class="menu-items" id="menuCategories"></div>

      <div class="form-group">
        <label>Ghi ch√∫</label>
        <input type="text" id="orderNote" placeholder="Ghi ch√∫ ƒë∆°n h√†ng (kh√¥ng b·∫Øt bu·ªôc)">
      </div>

      <div class="order-summary">
        <h3 style="margin-bottom: 15px;">üìã T·ªïng ƒë∆°n h√†ng</h3>
        <div id="orderSummaryItems"></div>
        <div class="total-row summary-row">
          <span>T·ªîNG C·ªòNG:</span>
          <span id="totalAmount">0ƒë</span>
        </div>
        <button class="submit-btn" onclick="createOrder()">‚úÖ T·∫°o ƒë∆°n h√†ng</button>
      </div>
    </div>
  `;
}

// üìë CHUY·ªÇN TAB
   function switchTab(tabName) {
  // ‚≠ê KI·ªÇM TRA QUY·ªÄN
  if (tabName === 'order' && !permissions.canCreateOrder) {
    alert('üîí B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o ƒë∆°n h√†ng!');
    return;
  }
  if (tabName === 'current' && !permissions.canViewOrders) {
    alert('üîí B·∫°n kh√¥ng c√≥ quy·ªÅn xem ƒë∆°n hi·ªán t·∫°i!');
    return;
  }
  if (tabName === 'report' && !permissions.canViewReports) {
    alert('üîí B·∫°n kh√¥ng c√≥ quy·ªÅn xem b√°o c√°o!');
    return;
  }

  // X√≥a active
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

  // Set active an to√†n
  const tabEl = document.getElementById(`tab-${tabName}`);
  const contentEl = document.getElementById(`content-${tabName}`);

  if (tabEl) tabEl.classList.add('active');
  if (contentEl) contentEl.classList.add('active');
}

    function toggleTableSelect() {
      const orderType = document.getElementById('orderType').value;
      const tableSelect = document.getElementById('tableSelect');
      tableSelect.style.display = orderType === 'dine' ? 'block' : 'none';
    }

   // üö™ ƒêƒÇNG XU·∫§T
    function logout() {
  if (confirm('X√°c nh·∫≠n ƒëƒÉng xu·∫•t?')) {
    // H·ªßy subscription tr∆∞·ªõc khi logout
    if (ordersSubscription) {
      supabase.removeChannel(ordersSubscription);
      ordersSubscription = null;
    }
    
    sessionStorage.removeItem('pizza_user');
    currentUser = null;
    permissions = {};
    
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
  }
}

    // ‚ôªÔ∏è KH√îI PH·ª§C SESSION
    (function checkSession() {
      const savedUser = sessionStorage.getItem('pizza_user');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          permissions = ROLE_PERMISSIONS[currentUser.role];
          initMainApp();
        } catch (error) {
          sessionStorage.removeItem('pizza_user');
        }
      }
        })();

    

    function toggleCategory(category) {
      const items = document.getElementById(`items-${category}`);
      const icon = document.getElementById(`icon-${category}`);
      const header = document.getElementById(`header-${category}`);
      
      items.classList.toggle('show');
      icon.classList.toggle('rotate');
      header.classList.toggle('active');
    }

    function searchMenu() {
      renderMenu();
    }

    function renderMenu() {
  const container = document.getElementById('menuCategories');
  const searchTerm = document.getElementById('searchMenu')?.value.toLowerCase() || '';
  
  container.innerHTML = Object.keys(menuData).map(category => {
    const items = menuData[category]
      .filter(item => {
        if (!searchTerm) return true;
        return item.name.toLowerCase().includes(searchTerm);
      })
      .map(item => `
      <div class="menu-item">
        <div>
          <strong>${item.name}</strong>
          <div style="color: #e74c3c; font-weight: 600;">${formatMoney(item.price)}</div>
        </div>
        <div class="quantity-control">
          <button class="qty-btn" onclick="updateCart('${item.id}', -1)">-</button>
          <span style="min-width: 30px; text-align: center; font-weight: 600;" data-item-id="${item.id}">${cart[item.id] || 0}</span>          <button class="qty-btn" onclick="updateCart('${item.id}', 1)">+</button>
        </div>
      </div>
    `).join('');

    if (items === '') return ''; // ·∫®n category n·∫øu kh√¥ng c√≥ m√≥n

    return `
      <div class="category-section">
        <div class="category-header" id="header-${category}" onclick="toggleCategory('${category}')">
          <span>üìÅ ${category}</span>
          <span class="category-icon" id="icon-${category}">‚ñº</span>
        </div>
        <div class="category-items ${searchTerm ? 'show' : ''}" id="items-${category}">
          ${items}
        </div>
      </div>
    `;
  }).join('');
}
 function updateCart(itemId, change) {
  if (!cart[itemId]) cart[itemId] = 0;
  cart[itemId] += change;
  if (cart[itemId] <= 0) delete cart[itemId];
  
  // Ch·ªâ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng hi·ªÉn th·ªã, kh√¥ng render l·∫°i
  updateQuantityDisplay(itemId);
  updateOrderSummary();
}

function updateQuantityDisplay(itemId) {
  // T√¨m t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ hi·ªÉn th·ªã s·ªë l∆∞·ª£ng c·ªßa m√≥n n√†y
  const quantityElements = document.querySelectorAll(`[data-item-id="${itemId}"]`);
  quantityElements.forEach(el => {
    el.textContent = cart[itemId] || 0;
  });
}

    function renderCategoryItems(category) {
      const container = document.getElementById(`items-${category}`);
      if (!container) return;

      const items = menuData[category].map(item => `
        <div class="menu-item">
          <div>
            <strong>${item.name}</strong>
            <div style="color: #e74c3c; font-weight: 600;">${formatMoney(item.price)}</div>
          </div>
          <div class="quantity-control">
            <button class="qty-btn" onclick="updateCart('${item.id}', -1)">-</button>
           <span style="min-width: 30px; text-align: center; font-weight: 600;" data-item-id="${item.id}">${cart[item.id] || 0}</span>
            <button class="qty-btn" onclick="updateCart('${item.id}', 1)">+</button>
          </div>
        </div>
      `).join('');

      container.innerHTML = items;
    }

    function findItemById(itemId) {
      for (const category in menuData) {
        const item = menuData[category].find(i => i.id === itemId);
        if (item) return item;
      }
      return null;
    }

    function updateOrderSummary() {
      const summaryItems = document.getElementById('orderSummaryItems');
      const totalAmount = document.getElementById('totalAmount');

      let total = 0;
      let html = '';

      Object.keys(cart).forEach(itemId => {
        const item = findItemById(itemId);
        if (!item) return;
        
        const qty = cart[itemId];
        const subtotal = item.price * qty;
        total += subtotal;

        html += `
          <div class="summary-row">
            <span>${item.name} x ${qty}</span>
            <span>${formatMoney(subtotal)}</span>
          </div>
        `;
      });

      summaryItems.innerHTML = html;
      totalAmount.textContent = formatMoney(total);
    }

   async function createOrder() {
  if (Object.keys(cart).length === 0) {
    alert('Vui l√≤ng ch·ªçn m√≥n!');
    return;
  }

  const orderType = document.getElementById('orderType').value;
  const tableNumber = document.getElementById('tableNumber').value;

  // Ki·ªÉm tra xem b√†n n√†y ƒë√£ c√≥ ƒë∆°n ch·ªù ch∆∞a
  if (orderType === 'dine') {
    const existingOrder = orders.find(o => 
      o.order_type === 'dine' && 
      o.table_number == tableNumber && 
      o.status === 'pending'
    );

    if (existingOrder) {
      // G·ªôp m√≥n v√†o ƒë∆°n hi·ªán t·∫°i
      Object.keys(cart).forEach(itemId => {
        if (existingOrder.items[itemId]) {
          existingOrder.items[itemId] += cart[itemId];
        } else {
          existingOrder.items[itemId] = cart[itemId];
        }
      });

      // T√≠nh l·∫°i t·ªïng ti·ªÅn
      existingOrder.total = Object.keys(existingOrder.items).reduce((sum, id) => {
        const item = findItemById(id);
        return sum + (item.price * existingOrder.items[id]);
      }, 0);

      // Th√™m ghi ch√∫ m·ªõi (n·∫øu c√≥)
      const newNote = document.getElementById('orderNote').value;
      if (newNote) {
        existingOrder.note = existingOrder.note 
          ? `${existingOrder.note} | ${newNote}` 
          : newNote;
      }

      try {
  // ‚≠ê C·∫¨P NH·∫¨T V√ÄO SUPABASE - Real-time s·∫Ω t·ª± ƒë·ªìng b·ªô sang kh√°ch
  const updateData = {
    items: existingOrder.items,
    total: existingOrder.total,
    note: existingOrder.note,
    updated_at: new Date().toISOString()
  };
  
  console.log('üîÑ Updating order:', existingOrder.id, updateData);
  
  const { error } = await supabase
    .from('orders')
    .update(updateData)
    .eq('id', existingOrder.id);

  if (error) {
    console.error('‚ùå Update error:', error);
    throw error;
  }
  
  console.log('‚úÖ Order updated successfully');
        
        // ‚≠ê C·∫¨P NH·∫¨T LOCAL STATE
        const orderIndex = orders.findIndex(o => o.id === existingOrder.id);
        if (orderIndex !== -1) {
          orders[orderIndex] = existingOrder;
        }

        cart = {};
        document.getElementById('orderNote').value = '';
        renderMenu();
        updateOrderSummary();
        await saveData();

        console.log('üéâ ƒê√£ th√™m m√≥n v√†o B√†n', tableNumber);
        alert(`‚úÖ ƒê√£ th√™m m√≥n v√†o B√†n ${tableNumber}!`);
        switchTab('current');

      } catch (error) {
          console.error('üî• L·ªói th√™m m√≥n:', error);
          alert('‚ùå C√≥ l·ªói khi th√™m m√≥n. Vui l√≤ng th·ª≠ l·∫°i!\n\nChi ti·∫øt: ' + error.message);
        }
      return;
    }
  }

  // T·∫°o ƒë∆°n m·ªõi n·∫øu ch∆∞a c√≥ ƒë∆°n
  const order = {
    id: Date.now(),
    store_code: currentStore,
    user_id: currentUser.id,

    order_type: orderType,
    table_number: orderType === 'dine' ? tableNumber : null,
    note: document.getElementById('orderNote').value,
    items: {...cart},
    total: Object.keys(cart).reduce((sum, id) => {
      const item = findItemById(id);
      return sum + (item.price * cart[id]);
    }, 0),
    status: 'pending',
    created_at: new Date().toISOString()
  };

  try {
    const { error } = await supabase
      .from('orders')
      .insert([order]);

    if (error) throw error;

    orders.push(order);
    cart = {};
    document.getElementById('orderNote').value = '';
    renderMenu();
    updateOrderSummary();
    renderOrders(); 
    alert('ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o!');
    switchTab('current');

  } catch (error) {
    console.error('L·ªói t·∫°o ƒë∆°n h√†ng:', error);
    alert('C√≥ l·ªói khi t·∫°o ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i!');
  }
}
    
    function renderOrders() {
  const grid = document.getElementById('ordersGrid');
  
  if (orders.length === 0) {
    grid.innerHTML = '<p style="text-align: center; color: #999;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</p>';
    return;
  }

  // ‚≠ê G·ªòP C√ÅC ƒê·ªöN C√ôNG B√ÄN (CH·ªà V·ªöI ƒê∆†N ƒÇN T·∫†I QU√ÅN)
  const mergedOrders = [];
  const tableOrders = {}; // { "table_1": [order1, order2, ...] }
  const otherOrders = []; // ƒê∆°n mang v·ªÅ, Grab, Shopee
  
  orders.forEach(order => {
    if (order.order_type === 'dine' && order.table_number) {
      const tableKey = `table_${order.table_number}`;
      if (!tableOrders[tableKey]) {
        tableOrders[tableKey] = [];
      }
      tableOrders[tableKey].push(order);
    } else {
      otherOrders.push(order);
    }
  });
  
  // G·ªôp ƒë∆°n c√πng b√†n th√†nh 1 ƒë∆°n t·ªïng h·ª£p
  Object.keys(tableOrders).forEach(tableKey => {
    const ordersForTable = tableOrders[tableKey];
    
    if (ordersForTable.length === 1) {
      // Ch·ªâ c√≥ 1 ƒë∆°n ‚Üí Gi·ªØ nguy√™n
      mergedOrders.push(ordersForTable[0]);
    } else {
      // C√≥ nhi·ªÅu ƒë∆°n ‚Üí G·ªôp l·∫°i
      const mergedOrder = {
        id: ordersForTable[0].id, // L·∫•y ID ƒë∆°n ƒë·∫ßu ti√™n ƒë·ªÉ x·ª≠ l√Ω
        order_ids: ordersForTable.map(o => o.id), // L∆∞u t·∫•t c·∫£ IDs ƒë·ªÉ thanh to√°n
        store_code: ordersForTable[0].store_code,
        order_type: 'dine',
        table_number: ordersForTable[0].table_number,
        items: {},
        total: 0,
        status: 'pending',
        created_at: ordersForTable[0].created_at,
        notes: [], // G·ªôp t·∫•t c·∫£ ghi ch√∫
        is_merged: true, // ƒê√°nh d·∫•u ƒë√¢y l√† ƒë∆°n g·ªôp
        order_source: ordersForTable.some(o => o.order_source === 'qr') ? 'qr' : 'staff'
      };
      
      // G·ªôp items v√† notes
      ordersForTable.forEach(order => {
        // G·ªôp items
        Object.keys(order.items).forEach(itemId => {
          if (mergedOrder.items[itemId]) {
            mergedOrder.items[itemId] += order.items[itemId];
          } else {
            mergedOrder.items[itemId] = order.items[itemId];
          }
        });
        
        // G·ªôp notes
        if (order.note) {
          mergedOrder.notes.push(order.note);
        }
        
        // C·ªông t·ªïng ti·ªÅn
        mergedOrder.total += order.total;
      });
      
      mergedOrders.push(mergedOrder);
    }
  });
  
  // Th√™m c√°c ƒë∆°n kh√¥ng ph·∫£i ƒÉn t·∫°i qu√°n
  mergedOrders.push(...otherOrders);
  
  // Render c√°c ƒë∆°n ƒë√£ g·ªôp
  grid.innerHTML = mergedOrders.map(order => {
    let typeClass, typeLabel, orderInfo = '';
    
    if (order.order_type === 'dine' || order.type === 'dine') {
      typeClass = 'type-dine';
      typeLabel = 'üçΩÔ∏è ƒÇn t·∫°i qu√°n';
      orderInfo = `<div style="margin-top: 5px; font-size: 14px;"><strong>B√†n ${order.table_number || order.table}</strong></div>`;
    } else if (order.order_type === 'takeout' || order.type === 'takeout') {
      typeClass = 'type-takeout';
      typeLabel = 'üì¶ Mang v·ªÅ';
    } else if (order.order_type === 'grab' || order.type === 'grab') {
      typeClass = 'type-grab';
      typeLabel = 'üõµ Grab';
    } else {
      typeClass = 'type-shopee';
      typeLabel = 'üõí Shopee';
    }

    // Badge QR n·∫øu ƒë∆°n t·ª´ kh√°ch
    const qrBadge = order.order_source === 'qr' ? '<span class="qr-badge">üì± QR Order</span>' : '';

    const isEditMode = order.editMode || false;

    const itemsHtml = Object.keys(order.items).map(itemId => {
      const item = findItemById(itemId);
      if (!item) return '';
      
      const qty = order.items[itemId];
      const subtotal = item.price * qty;

      if (isEditMode) {
        return `
          <div class="order-item">
            <div class="order-item-left">
              <span>${item.name}</span>
              <div class="item-qty-control">
                <button class="item-qty-btn" onclick="updateOrderItem('${order.id}', '${itemId}', -1)">-</button>
                <span style="font-weight: 600; min-width: 25px; text-align: center;">${qty}</span>
                <button class="item-qty-btn" onclick="updateOrderItem('${order.id}', '${itemId}', 1)">+</button>
              </div>
            </div>
            <div style="display: flex; align-items: center;">
              <span style="font-weight: 600;">${formatMoney(subtotal)}</span>
              <button class="delete-item-btn" onclick="deleteOrderItem('${order.id}', '${itemId}')">√ó</button>
            </div>
          </div>
        `;
      } else {
        return `
          <div class="order-item">
            <span>${item.name} x ${qty}</span>
            <span>${formatMoney(subtotal)}</span>
          </div>
        `;
      }
    }).join('');

    const timestamp = order.created_at ? new Date(order.created_at).toLocaleString('vi-VN') : order.timestamp;

    return `
      <div class="order-card ${isEditMode ? 'edit-mode' : ''}">
        <div class="order-header">
          <div>
            <span class="order-type ${typeClass}">${typeLabel}</span>
            ${qrBadge}
            ${orderInfo}
            <div style="margin-top: 8px; font-size: 12px; color: #999;">${timestamp}</div>
          </div>
          <div style="font-size: 20px; font-weight: 700; color: #e74c3c;">
            ${formatMoney(order.total)}
          </div>
        </div>
        ${order.is_merged && order.notes.length > 0 ? 
  `<div style="margin-bottom: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
    <strong>üìù Ghi ch√∫:</strong><br>
    ${order.notes.map((note, i) => `‚Ä¢ ${note}`).join('<br>')}
  </div>` 
  : order.note ? 
  `<div style="margin-bottom: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;"><strong>üìù Ghi ch√∫:</strong> ${order.note}</div>` 
  : ''}
        <div class="order-items">
          ${itemsHtml}
        </div>
        

${isEditMode ? `
  <button class="payment-btn" style="background: #27ae60; color: white; margin-top: 15px;" onclick="saveOrderEdit('${order.id}')">‚úÖ L∆∞u thay ƒë·ªïi</button>
  <button class="payment-btn" style="background: #95a5a6; color: white; margin-top: 10px;" onclick="cancelOrderEdit('${order.id}')">‚ùå H·ªßy</button>
` : `
  <div class="payment-buttons" style="margin-top: 15px;">
    ${permissions.canEditOrder ? `<button class="edit-order-btn" onclick="enableEditMode('${order.id}')">‚úèÔ∏è S·ª≠a ƒë∆°n</button>` : ''}
    ${permissions.canPayOrder ? `<button class="payment-btn" style="background: #9b59b6; color: white; flex: 1;" onclick="showBillPreview(${order.id})">üëÅÔ∏è Xem h√≥a ƒë∆°n</button>` : ''}
  </div>
`}
      </div>
    `;
  }).join('');
}

// Th√™m h√†m x√°c nh·∫≠n thanh to√°n (ƒë·∫∑t tr∆∞·ªõc h√†m payOrder)
function confirmPayment(orderId, method) {
  const order = orders.find(o => o.id == orderId);
  if (!order) return;

  const methodLabels = {
    'cash': 'üíµ Ti·ªÅn m·∫∑t',
    'transfer': 'üè¶ Chuy·ªÉn kho·∫£n',
    'grab': 'üõµ Grab',
    'shopee': 'üõí Shopee'
  };
  
  if (confirm(`X√°c nh·∫≠n thanh to√°n ${formatMoney(order.total)} b·∫±ng ${methodLabels[method]}?`)) {
    payOrder(orderId, method);
  }
}

 async function payOrder(orderId, method) {
  const order = orders.find(o => o.id == orderId);
  if (!order) return;

  const methodLabels = {
    'cash': 'üíµ Ti·ªÅn m·∫∑t',
    'transfer': 'üè¶ Chuy·ªÉn kho·∫£n',
    'grab': 'üõµ Grab',
    'shopee': 'üõí Shopee'
  };
  
  if (!confirm(`X√°c nh·∫≠n thanh to√°n ${formatMoney(order.total)} b·∫±ng ${methodLabels[method]}?`)) {
    return;
  }

  try {
    // ‚≠ê N·∫øu l√† ƒë∆°n g·ªôp ‚Üí Thanh to√°n T·∫§T C·∫¢ ƒë∆°n con
    const orderIds = order.is_merged ? order.order_ids : [orderId];
    
    const { error } = await supabase
      .from('orders')
      .update({ 
        status: 'paid',
        payment_method: method 
      })
      .in('id', orderIds); // Thanh to√°n nhi·ªÅu ƒë∆°n c√πng l√∫c

    if (error) throw error;

    // ‚≠ê N·∫øu ƒë∆°n c√≥ QR ‚Üí ƒê√≥ng session
    if (order.order_type === 'dine' && order.table_number) {
      const { data: sessions } = await supabase
        .from('qr_sessions')
        .select('token')
        .eq('store_code', currentStore)
        .eq('table_number', order.table_number)
        .eq('status', 'active');
      
      if (sessions && sessions.length > 0) {
        await supabase
          .from('qr_sessions')
          .update({ status: 'closed' })
          .in('token', sessions.map(s => s.token));
      }
    }
    
    // C·∫≠p nh·∫≠t b√°o c√°o - X·ª¨ L√ù ƒê∆†N G·ªòP ƒê√öNG
const ordersToUpdate = order.is_merged 
  ? orders.filter(o => order.order_ids.includes(o.id))
  : [order];

ordersToUpdate.forEach(singleOrder => {
  dailyReport.revenue.total += singleOrder.total;
  dailyReport.revenue[method] = (dailyReport.revenue[method] || 0) + singleOrder.total;
  
  if (method === 'cash') {
    dailyReport.cash.collected = (dailyReport.cash.collected || 0) + singleOrder.total;
  }

  Object.keys(singleOrder.items).forEach(itemId => {
    const item = findItemById(itemId);
    if (!item) return;
    
    if (!dailyReport.items[item.name]) {
      dailyReport.items[item.name] = 0;
    }
    dailyReport.items[item.name] += singleOrder.items[itemId];
  });
});

    // ‚≠ê X√≥a T·∫§T C·∫¢ ƒë∆°n con kh·ªèi danh s√°ch
    orders = orders.filter(o => !orderIds.includes(o.id));
    
    await saveData();
    renderOrders();
    updateReports();
    alert('ƒê√£ thanh to√°n th√†nh c√¥ng!');

  } catch (error) {
    console.error('L·ªói thanh to√°n:', error);
    alert('C√≥ l·ªói khi thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i!');
  }
}

function toggleReportSection(section) {
  const items = document.getElementById(`items-${section}`);
  const icon = document.getElementById(`icon-${section}`);
  
  items.classList.toggle('show');
  icon.classList.toggle('rotate');
}

    function updateReports() {
  document.getElementById('totalRevenue').textContent = formatMoney(dailyReport.revenue.total);
  document.getElementById('cashRevenue').textContent = formatMoney(dailyReport.revenue.cash || 0);
  document.getElementById('transferRevenue').textContent = formatMoney(dailyReport.revenue.transfer || 0);
  document.getElementById('grabRevenue').textContent = formatMoney(dailyReport.revenue.grab || 0);
  document.getElementById('shopeeRevenue').textContent = formatMoney(dailyReport.revenue.shopee || 0);

  const soldItems = document.getElementById('soldItems');
  const itemsHtml = Object.keys(dailyReport.items).map(name => `
    <div class="order-item">
      <span>${name}</span>
      <strong>${dailyReport.items[name]} m√≥n</strong>
    </div>
  `).join('');
  soldItems.innerHTML = itemsHtml || '<p style="color: #999;">Ch∆∞a c√≥ m√≥n n√†o ƒë∆∞·ª£c b√°n</p>';

  document.getElementById('displayStartCash').textContent = formatMoney(dailyReport.cash.start);
  document.getElementById('displayCashRevenue').textContent = formatMoney(dailyReport.revenue.cash || 0);
  document.getElementById('displayTotalCash').textContent = formatMoney((dailyReport.cash.start || 0) + (dailyReport.cash.collected || 0));

}

    function setStartCash() {
  if (!permissions.canManageCash) {
    alert('üîí B·∫°n kh√¥ng c√≥ quy·ªÅn qu·∫£n l√Ω k√©t ti·ªÅn!');
    return;
  }
  
  const amount = parseInt(document.getElementById('startCash').value);
  if (isNaN(amount) || amount < 0) {
    alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!');
    return;
  }
  dailyReport.cash.start = amount;
  document.getElementById('startCash').value = '';
  saveData();
  updateReports();
  alert('ƒê√£ c·∫≠p nh·∫≠t ti·ªÅn ƒë·∫ßu ng√†y!');
}

function resetCashRegister() {
  if (!permissions.canManageCash) {
    alert('üîí B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªët k√©t ti·ªÅn!');
    return;
  }
  
  if (!confirm('X√°c nh·∫≠n ch·ªët k√©t v√† reset d·ªØ li·ªáu ng√†y m·ªõi?')) return;

  const totalCash = dailyReport.cash.start + dailyReport.cash.current;
  alert(`T·ªïng k√©t ti·ªÅn: ${formatMoney(totalCash)}\n\nƒê√£ reset d·ªØ li·ªáu ng√†y m·ªõi!`);

  dailyReport = {
    revenue: { total: 0, cash: 0, transfer: 0, grab: 0, shopee: 0 },
    items: {},
    cash: { start: 0, current: 0, collected: 0 }
  };

  saveData();
  updateReports();
}
    function formatMoney(amount) {
      return amount.toLocaleString('vi-VN') + 'ƒë';
    }

    async function saveData() {
      try {
        // L∆∞u daily report
        const { error: reportError } = await supabase
          .from('daily_reports')
          .upsert({
            store_code: currentStore,
            user_id: currentUser.id,

            report_date: new Date().toISOString().split('T')[0],
            revenue: dailyReport.revenue,
            items_sold: dailyReport.items,
            cash_register: dailyReport.cash,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'store_code,user_id,report_date'
          });

        if (reportError) throw reportError;

        // V·∫´n gi·ªØ localStorage ƒë·ªÉ backup
        const data = { orders, dailyReport, timestamp: Date.now() };
        const key = `pizza_${currentStore}_${currentUser.id}`;
        localStorage.setItem(key, JSON.stringify(data));

      } catch (error) {
        console.error('L·ªói l∆∞u d·ªØ li·ªáu:', error);
        alert('C√≥ l·ªói khi l∆∞u d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i!');
      }
    }

   async function loadData() {
  try {
    const today = new Date().toISOString().split('T')[0];
    
    const { data: reportData, error } = await supabase
      .from('daily_reports')
      .select('*')
      .eq('store_code', currentStore)
      .eq('user_id', currentUser.id)
      .eq('report_date', today)
      .single();

    if (reportData && !error) {
      dailyReport = {
        revenue: reportData.revenue,
        items: reportData.items_sold,
        cash: reportData.cash_register
      };
      // ƒê·∫£m b·∫£o c√≥ collected
  if (!dailyReport.cash.collected) {
    dailyReport.cash.collected = 0;
  }
  if (!dailyReport.revenue.cash) {
    dailyReport.revenue.cash = 0;
  }
    } else {
      dailyReport = {
        revenue: { total: 0, cash: 0, transfer: 0, grab: 0, shopee: 0 },
        items: {},
        cash: { start: 0, current: 0 }
      };
    }

    // Load t·∫•t c·∫£ ƒë∆°n pending c·ªßa qu√°n n√†y (bao g·ªìm c·∫£ QR orders)
    const { data: ordersData, error: ordersError } = await supabase
      .from('orders')
      .select('*')
      .eq('store_code', currentStore)
      .eq('status', 'pending')
      .order('created_at', { ascending: false });

    if (ordersData && !ordersError) {
      orders = ordersData;
    }

    // K√≠ch ho·∫°t real-time subscription
    subscribeToOrders();

  } catch (error) {
    console.error('L·ªói load d·ªØ li·ªáu:', error);
  }
}

function showBillPreview(orderId) {
  const order = orders.find(o => o.id === orderId);
  if (!order) return;

  const typeLabels = {
    'dine': 'üçΩÔ∏è ƒÇn t·∫°i qu√°n',
    'takeout': 'üì¶ Mang v·ªÅ',
    'grab': 'üõµ Grab',
    'shopee': 'üõí Shopee'
  };

  let itemsHtml = Object.keys(order.items).map(itemId => {
    const item = findItemById(itemId);
    if (!item) return '';
    const qty = order.items[itemId];
    const subtotal = item.price * qty;
    return `
      <div class="bill-item">
        <div>
          <div style="font-weight: 600;">${item.name}</div>
          <div style="font-size: 13px; color: #777;">${formatMoney(item.price)} x ${qty}</div>
        </div>
        <div style="font-weight: 600;">${formatMoney(subtotal)}</div>
      </div>
    `;
  }).join('');

  // ·∫®n main app
  document.getElementById('mainApp').style.display = 'none';

  // T·∫°o trang h√≥a ƒë∆°n m·ªõi
  const billPage = document.createElement('div');
  billPage.id = 'billPage';
  billPage.style.cssText = 'min-height: 100vh; background: white; padding: 20px;';
  billPage.innerHTML = `
    <div style="max-width: 600px; margin: 0 auto;">
      <div style="background: #e74c3c; color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0;">üßæ H√≥a ƒê∆°n Chi Ti·∫øt</h2>
        <button onclick="closeBillPage()" style="background: white; color: #e74c3c; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚Üê Quay l·∫°i</button>
      </div>
      <div style="background: white; padding: 30px; border: 2px solid #e74c3c; border-top: none; border-radius: 0 0 12px 12px;">
        <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
          <div style="margin-bottom: 8px;"><strong>Lo·∫°i ƒë∆°n:</strong> ${typeLabels[order.order_type] || order.order_type}</div>
          ${order.table_number ? `<div style="margin-bottom: 8px;"><strong>B√†n s·ªë:</strong> ${order.table_number}</div>` : ''}
          ${order.note ? `<div><strong>Ghi ch√∫:</strong> ${order.note}</div>` : ''}
        </div>
        <h3 style="margin-bottom: 15px; color: #e74c3c;">Chi ti·∫øt m√≥n:</h3>
        ${itemsHtml}
        <div style="display: flex; justify-content: space-between; padding: 20px 0 10px 0; border-top: 2px solid #e74c3c; font-size: 20px; font-weight: 700; color: #e74c3c; margin-top: 15px;">
          <span>T·ªîNG C·ªòNG:</span>
          <span>${formatMoney(order.total)}</span>
        </div>
        <div style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button onclick="payOrder(${order.id}, 'cash'); closeBillPage();" style="background: #27ae60; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">üíµ Ti·ªÅn m·∫∑t</button>
          <button onclick="payOrder(${order.id}, 'transfer'); closeBillPage();" style="background: #3498db; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">üè¶ Chuy·ªÉn kho·∫£n</button>
          <button onclick="payOrder(${order.id}, 'grab'); closeBillPage();" style="background: #00b14f; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">üõµ Grab</button>
          <button onclick="payOrder(${order.id}, 'shopee'); closeBillPage();" style="background: #ee4d2d; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">üõí Shopee</button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(billPage);
}

function closeBillPage() {
  const billPage = document.getElementById('billPage');
  if (billPage) {
    billPage.remove();
  }
  document.getElementById('mainApp').style.display = 'block';
}


// ƒê√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
  const modal = document.getElementById('billModal');
  if (event.target == modal) {
    modal.style.display = 'none';
  }
}

// C√°c h√†m x·ª≠ l√Ω s·ª≠a/x√≥a m√≥n
let orderBackup = null;

function enableEditMode(orderId) {
  const order = orders.find(o => o.id == orderId);
  if (!order) return;
  
  // Backup ƒë∆°n h√†ng ƒë·ªÉ c√≥ th·ªÉ h·ªßy
  orderBackup = JSON.parse(JSON.stringify(order));
  
  order.editMode = true;
  renderOrders();
}

function cancelOrderEdit(orderId) {
  const orderIndex = orders.findIndex(o => o.id == orderId);
  if (orderIndex === -1 || !orderBackup) return;
  
  // Kh√¥i ph·ª•c ƒë∆°n h√†ng t·ª´ backup
  orders[orderIndex] = orderBackup;
  orderBackup = null;
  
  renderOrders();
}

async function saveOrderEdit(orderId) {
  const order = orders.find(o => o.id == orderId);
  if (!order) return;
  
  // T√≠nh l·∫°i t·ªïng ti·ªÅn
  order.total = Object.keys(order.items).reduce((sum, itemId) => {
    const item = findItemById(itemId);
    if (!item) return sum;
    return sum + (item.price * order.items[itemId]);
  }, 0);
  
  order.editMode = false;
  orderBackup = null;
  
  try {
    // C·∫≠p nh·∫≠t v√†o Supabase
    const { error } = await supabase
      .from('orders')
      .update({ 
        items: order.items,
        total: order.total,
        updated_at: new Date().toISOString()
      })
      .eq('id', orderId);

    if (error) throw error;
    
    await saveData();
    renderOrders();
    alert('ƒê√£ l∆∞u thay ƒë·ªïi!');
    
  } catch (error) {
    console.error('L·ªói l∆∞u thay ƒë·ªïi:', error);
    alert('C√≥ l·ªói khi l∆∞u. Vui l√≤ng th·ª≠ l·∫°i!');
  }
}

async function updateOrderItem(orderId, itemId, change) {
  const order = orders.find(o => o.id == orderId);
  if (!order) return;
  
  if (!order.items[itemId]) order.items[itemId] = 0;
  order.items[itemId] += change;
  
  // X√≥a m√≥n n·∫øu s·ªë l∆∞·ª£ng <= 0
  if (order.items[itemId] <= 0) {
    delete order.items[itemId];
  }
  
  // T√≠nh l·∫°i t·ªïng
  order.total = Object.keys(order.items).reduce((sum, id) => {
    const item = findItemById(id);
    if (!item) return sum;
    return sum + (item.price * order.items[id]);
  }, 0);
  
  // ‚≠ê C·∫¨P NH·∫¨T V√ÄO SUPABASE NGAY
  try {
    const { error } = await supabase
      .from('orders')
      .update({ 
        items: order.items,
        total: order.total,
        updated_at: new Date().toISOString()
      })
      .eq('id', orderId);

    if (error) throw error;
  } catch (error) {
    console.error('L·ªói c·∫≠p nh·∫≠t m√≥n:', error);
    alert('C√≥ l·ªói khi c·∫≠p nh·∫≠t. Vui l√≤ng th·ª≠ l·∫°i!');
    return;
  }
  
  renderOrders();
}

function deleteOrderItem(orderId, itemId) {
  const order = orders.find(o => o.id == orderId);
  if (!order) return;
  
  const item = findItemById(itemId);
  if (!item) return;
  
  if (!confirm(`X√≥a m√≥n "${item.name}" kh·ªèi ƒë∆°n h√†ng?`)) return;
  
  delete order.items[itemId];
  
  // N·∫øu kh√¥ng c√≤n m√≥n n√†o, x√≥a lu√¥n ƒë∆°n h√†ng
  if (Object.keys(order.items).length === 0) {
    if (confirm('ƒê∆°n h√†ng kh√¥ng c√≤n m√≥n n√†o. X√≥a lu√¥n ƒë∆°n h√†ng?')) {
      deleteOrder(orderId);
      return;
    }
  }
  
  // T√≠nh l·∫°i t·ªïng
  order.total = Object.keys(order.items).reduce((sum, id) => {
    const item = findItemById(id);
    if (!item) return sum;
    return sum + (item.price * order.items[id]);
  }, 0);
  
  renderOrders();
}

async function deleteOrder(orderId) {
  try {
    const { error } = await supabase
      .from('orders')
      .delete()
      .eq('id', orderId);

    if (error) throw error;
    
    orders = orders.filter(o => o.id != orderId);
    await saveData();
    renderOrders();
    alert('ƒê√£ x√≥a ƒë∆°n h√†ng!');
    
  } catch (error) {
    console.error('L·ªói x√≥a ƒë∆°n:', error);
    alert('C√≥ l·ªói khi x√≥a. Vui l√≤ng th·ª≠ l·∫°i!');
  }
}

// Real-time subscription cho ƒë∆°n h√†ng m·ªõi
let ordersSubscription = null;

function subscribeToOrders() {
  // H·ªßy subscription c≈© n·∫øu c√≥
  if (ordersSubscription) {
    supabase.removeChannel(ordersSubscription);
  }

  // T·∫°o subscription m·ªõi
  ordersSubscription = supabase
    .channel('staff-orders')
    .on('postgres_changes', 
      { 
        event: 'INSERT', 
        schema: 'public', 
        table: 'orders',
        filter: `store_code=eq.${currentStore}`
      }, 
      (payload) => {
        console.log('üì± ƒê∆°n h√†ng m·ªõi:', payload.new);
        
        // Th√™m ƒë∆°n m·ªõi v√†o danh s√°ch
        orders.unshift(payload.new);
        
        // Hi·ªán th√¥ng b√°o n·∫øu l√† ƒë∆°n QR
        if (payload.new.order_source === 'qr') {
          showNotification(`üîî ƒê∆°n QR m·ªõi - B√†n ${payload.new.table_number}`, payload.new);
        }
        
        // T·ª± ƒë·ªông render l·∫°i n·∫øu ƒëang ·ªü tab ƒê∆°n Hi·ªán T·∫°i
        const currentTab = document.querySelector('.tab.active');
        const tabIndex = Array.from(document.querySelectorAll('.tab')).indexOf(currentTab);
        if (tabIndex === 1) {
          renderOrders();
        }
        
        // C·∫≠p nh·∫≠t badge s·ªë ƒë∆°n ch∆∞a x·ª≠ l√Ω (optional)
        updateOrderBadge();
      }
    )
    .subscribe();
}

// Hi·ªán th√¥ng b√°o ƒë∆°n m·ªõi
function showNotification(message, order) {
  // Ki·ªÉm tra quy·ªÅn th√¥ng b√°o tr√¨nh duy·ªát
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(message, {
      body: `T·ªïng: ${formatMoney(order.total)}\n${Object.keys(order.items).length} m√≥n`,
      icon: 'üçï',
      tag: 'pizza-order'
    });
  }
  
  // Alert ƒë∆°n gi·∫£n (lu√¥n hi·ªán)
  if (confirm(`${message}\n\nT·ªïng: ${formatMoney(order.total)}\n\nXem ƒë∆°n h√†ng ngay?`)) {
    switchTab('current'); // Chuy·ªÉn sang tab ƒê∆°n Hi·ªán T·∫°i
  }
}

// C·∫≠p nh·∫≠t badge s·ªë ƒë∆°n (optional - th√™m sau n·∫øu mu·ªën)
function updateOrderBadge() {
  const pendingCount = orders.filter(o => o.status === 'pending').length;
  const qrCount = orders.filter(o => o.order_source === 'qr' && o.status === 'pending').length;
  
  console.log(`üìä T·ªïng ${pendingCount} ƒë∆°n ch·ªù (${qrCount} ƒë∆°n QR)`);
  
  // C√≥ th·ªÉ th√™m badge v√†o tab "ƒê∆°n Hi·ªán T·∫°i" ·ªü ƒë√¢y
}

// Y√™u c·∫ßu quy·ªÅn th√¥ng b√°o khi ƒëƒÉng nh·∫≠p
function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

// Kh√¥i ph·ª•c session khi load trang
(async function() {
  const savedUser = localStorage.getItem('pizza_current_user');
  const savedStore = localStorage.getItem('pizza_current_store');

  if (savedUser && savedStore) {
    currentUser = savedUser;
    currentStore = savedStore;
    
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('storeBadge').textContent = savedStore;
    document.getElementById('userDisplay').textContent = `User: ${savedUser}`;
    
    requestNotificationPermission();
    await loadData();
    renderMenu();
    toggleTableSelect();
    updateReports();
  }
})();
  </script>
</body>
</html>
